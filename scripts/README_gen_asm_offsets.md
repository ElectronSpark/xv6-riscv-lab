# Assembly Offset Generator

This script automatically generates C structure offset definitions for use in assembly files. It uses the Linux kernel approach of compiling C code with inline assembly directives, then extracting the offsets from the assembly output.

## Usage

### Command Line

```bash
# Basic usage with command-line arguments
./gen_asm_offsets.py \
  --include kernel/inc \
  --struct trapframe:trapframe.h:all \
  --struct proc:proc.h:lock,state,trapframe \
  --output asm-offsets.h

# Using a configuration file
./gen_asm_offsets.py --config asm-offsets-config.json --output asm-offsets.h

# Verbose mode for debugging
./gen_asm_offsets.py --config asm-offsets-config.json -v
```

### Configuration File

Create a JSON configuration file (e.g., `asm-offsets-config.json`):

```json
{
  "includes": [
    "kernel/inc"
  ],
  "headers": [
    "types.h",
    "param.h",
    "riscv.h"
  ],
  "structures": [
    {
      "name": "trapframe",
      "header": "trapframe.h",
      "fields": "all"
    },
    {
      "name": "proc",
      "header": "proc.h",
      "fields": [
        "lock",
        "state",
        "trapframe",
        "context"
      ]
    }
  ]
}
```

### Configuration Fields

- **includes**: List of include directories (required)
- **headers**: List of header files to include before structure headers (optional)
  - Use this to include prerequisite headers like `types.h`, `param.h`, etc.
  - Headers are included in the order specified
- **structures**: List of structures to generate offsets for (required)
  - **name**: Structure name (without `struct` keyword)
  - **header**: Header file containing the structure definition
  - **fields**: Either `"all"` to auto-detect all fields, or an array of specific field names

## How It Works

1. **Generate C Code**: Creates a C file with:
   - Include directives for your headers
   - Macro definitions using inline assembly
   - Offset/size calculation calls

2. **Compile to Assembly**: Compiles the C file to assembly using the specified compiler

3. **Extract Offsets**: Parses the assembly output to find special directives and generates `#define` statements

4. **Write Header**: Outputs a header file with all offset definitions

## Examples

### Auto-detect All Fields

```bash
./gen_asm_offsets.py \
  -I kernel/inc \
  --struct trapframe:trapframe.h:all \
  -o offsets.h
```

### Specific Fields Only

```bash
./gen_asm_offsets.py \
  -I kernel/inc \
  --struct proc:proc.h:state,trapframe,context \
  -o offsets.h
```

### Multiple Structures

```bash
./gen_asm_offsets.py \
  -I kernel/inc \
  --struct trapframe:trapframe.h:all \
  --struct proc:proc.h:all \
  --struct context:proc.h:all \
  -o offsets.h
```

### Custom Compiler

```bash
./gen_asm_offsets.py \
  --config config.json \
  --compiler riscv64-unknown-elf-gcc \
  -o offsets.h
```

## Integration with CMake

In your `CMakeLists.txt`:

```cmake
set(GEN_ASM_OFFSETS_SCRIPT ${CMAKE_SOURCE_DIR}/scripts/gen_asm_offsets.py)
set(ASM_OFFSETS_CONFIG ${CMAKE_CURRENT_SOURCE_DIR}/asm-offsets-config.json)
set(ASM_OFFSETS_H ${CMAKE_CURRENT_BINARY_DIR}/asm-offsets.h)

if(DEFINED ENV{TOOLPREFIX})
    set(ASM_OFFSETS_COMPILER "$ENV{TOOLPREFIX}gcc")
else()
    set(ASM_OFFSETS_COMPILER ${CMAKE_C_COMPILER})
endif()

add_custom_command(
    OUTPUT ${ASM_OFFSETS_H}
    COMMAND ${GEN_ASM_OFFSETS_SCRIPT}
        --config ${ASM_OFFSETS_CONFIG}
        --compiler ${ASM_OFFSETS_COMPILER}
        --include ${CMAKE_SOURCE_DIR}/kernel/inc
        --output ${ASM_OFFSETS_H}
    DEPENDS ${ASM_OFFSETS_CONFIG} ${GEN_ASM_OFFSETS_SCRIPT}
    WORKING_DIRECTORY ${CMAKE_SOURCE_DIR}
    COMMENT "Generating asm-offsets.h from configuration"
    VERBATIM
)

add_custom_target(generate_asm_offsets DEPENDS ${ASM_OFFSETS_H})
```

## Output Format

The generated header file contains:

```c
/* Auto-generated by gen_asm_offsets.py */
/* DO NOT EDIT - Changes will be overwritten */

/* trapframe structure offsets */
#define TF_KERNEL_SATP 0
#define TF_KERNEL_SP 8
#define TF_RA 40
...
#define TRAPFRAME_SIZE 344

/* proc structure offsets */
#define PROC_STATE 24
#define PROC_TRAPFRAME 776
...
#define PROC_SIZE 1504
```

## Using in Assembly Files

Include the generated header in your `.S` files:

```asm
#include "inc/asm-offsets.h"

.globl example
example:
    # Load trapframe pointer
    ld a0, PROC_TRAPFRAME(a1)
    
    # Save registers with symbolic offsets
    sd ra, TF_RA(a0)
    sd sp, TF_SP(a0)
    
    ret
```

## Troubleshooting

### Compilation Errors

If you get compilation errors about missing types or undefined symbols:

1. Add required headers to the `"headers"` array in your config
2. Make sure `"types.h"` is included first if your code uses custom types
3. Include headers in dependency order (types → constants → structures)

### Auto-detection Not Working

If field auto-detection fails:

1. Specify fields explicitly in the configuration
2. Use verbose mode (`-v`) to see what the script is doing
3. Check that the header file is in the include path

### Wrong Compiler

Make sure you're using the correct cross-compiler:

```bash
./gen_asm_offsets.py --compiler riscv64-unknown-elf-gcc ...
```

## Requirements

- Python 3.6+
- C compiler (gcc or cross-compiler)
- Header files for the structures you want to process
